<apex:page controller="SalesIQ.TerritoryCtlr" sidebar="false" id="mainpage"
    tabstyle="Territory_Management__tab">

    <apex:form id="form1">
        <apex:outputPanel id="msgPnl">
            <apex:pageMessages id="myMsg" rendered="{!!displayDeleteAll}" />
        </apex:outputPanel>
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.10.0/jquery.min.js" />
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js" />
        <!--     <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" /> -->
        <apex:includeScript value="https://mottie.github.io/tablesorter/js/jquery.tablesorter.js" />
        <apex:includeScript value="{!URLFOR($Resource.SalesIQ__DynaTree, 'jquery/jquery.js' )}" />
        <apex:includeScript value="{!URLFOR($Resource.SalesIQ__DynaTree, 'jquery/jquery-ui.custom.js' )}" />
        <apex:includeScript value="{!URLFOR($Resource.SalesIQ__DynaTree, 'jquery/jquery.cookie.js' )}" />
        <apex:includeScript value="{!URLFOR($Resource.SalesIQ__DynaTree, 'src/jquery.dynatree.js' )}" />
        <apex:stylesheet value="{!URLFOR($Resource.SalesIQ__DynaTree, 'src/skin/ui.dynatree.css')}" />
        <head>
<style>
body button,body .x-btn,body .btn,body .btnDisabled,body .btnCancel,body .menuButton .menuButtonButton
    {
    padding: 2px 6px;
}

.dynatree-container {
    border: 0px !important;
}

.box-main {
    width: 100%;
    margin: 30px auto;
}

.box-content {
    background-color: #f7f7f7;
    padding: 5px;
    border: 1px solid #cccccc;
}

.box-content-popup {
    background-color: #fff;
    font-size: 14px;
    padding: 5px;
    border: 1px solid #000;
    text-align: center;
}

td {
    font-size: 11px !important;
    line-height: 16px !important;
}

.box-top-popup {
    border-top: 3px solid #00335B;
    -moz-border-top: 3px solid #00335B;
    -webkit-border-top: 3px solid #00335B;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    -moz-border-top-left-radius: 10px;
    -moz-border-top-right-radius: 10px;
    -webkit-border-top-left-radius: 10px;
    -webkit-border-top-right-radius: 10px;
    background-color: #F8F8F8;
    border-left: 1px solid #000;
    border-right: 1px solid #000;
    color: #000;
    padding: 12px 0 0 15px;
    font-weight: 600;
    font-size: 18px;
    height: 30px;
}

.box-top {
    border-top: 3px solid #00335B;
    -moz-border-top: 3px solid #00335B;
    -webkit-border-top: 3px solid #00335B;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    -moz-border-top-left-radius: 10px;
    -moz-border-top-right-radius: 10px;
    -webkit-border-top-left-radius: 10px;
    -webkit-border-top-right-radius: 10px;
    background-color: #F8F8F8;
    border-left: 1px solid #cccccc;
    border-right: 1px solid #cccccc;
    color: #000;
    padding: 12px 0 0 15px;
    font-weight: 600;
    font-size: 18px;
    height: 30px;
}

.tablecontent {
    vertical-align: top;
    height: 400px;
    background-color: #fff;
    margin-left: 290px;
    border: 1px solid #989898;
    font-size: 12px;
    overflow-y: auto;
}

.box-top-div1 {
    /*width: 30%;*/
    font-weight: 600;
    font-size: 17px;
    float: left;
    text-align: left;
    height: 25px;
    color: #666 !important;
}

.box-top-div2 {
    width: 25%;
    font-weight: 600;
    font-size: 12px;
    float: left;
    text-align: center;
    height: 25px;
}

.box-top-div3 {
    /*width: 5%;*/
    font-weight: 600;
    font-size:12px;
    font-weight:400;
    color:#666;
    float: left;
    height: 25px;
}

.box-top-div4 {
    width: 25%;
    font-weight: 600;
    font-size: 13px;
    float: left;
    height: 25px;
}

.box-top-div5 {
    /*width: 33%;*/
    font-size: 11px;
    text-align: right;
    float: right;
    height: 25px;
    padding-right: 10px;
}

.searchbutton1 {
    width: 80px;
    height: 23px;
    font-size: 11px !important;
    margin-left: -80px !important;
    border: 1px solid #3fa9f5 !important;
    background-color: #55a4da !important;
    z-index: 1;
}

.searchtxt1 {
    border: 1px solid #3fa9f5;
    border-radius: 5px;
    height: 21px;
    /* margin-left: 100px; */
    padding-top: 0px;
    width: 235px;
}

.button {
    padding: 1px 10px !important;
    border: 1px solid #3fa9f5 !important;
    font-size: 11px !important;
    font-weight: bold !important;
    height: 22px !important;
    text-align: right;
}

.tree1 {
    width: 275px;
    vertical-align: top;
    float: left;
    height: 400px;
    background-color: #fff;
    border: 1px solid #989898;
}

#tree {
    height: 370px;
    overflow-y: auto;
}

.clear {
    clear: both;
}

th {
    color: #fff !important;
    background-color: #277AA8 !important;
    font-size: 11.5px !important;
    line-height: 20px;
    border:0px !important;
    border-collapse:collapse !important;
}

.table_header_tree {
    color: #fff !important;
    background-color: #277AA8 !important;
    font-size: 12px !important;
    font-weight: bold;
    line-height: 30px !important;
    padding-left: 12px;
    -webkit-overflow-scrolling: touch;
}

.table_header_main {
    color: #404041 !important;
    background-color: #277AA8 !important;
    font-size: 16px !important;
    text-align: center;
    line-height: 30px !important;
}

td {
    line-height: 20px;
}

.even {
    /* background-color: White !important;*/

}

.odd {
    /* background-color: #e6f5fc !important; */

}

.number {
    text-align: left;
}

.text {
    text-align: center;
}

.table {
    border: 1px solid;
    line-height: 25px !important;
}

.table-side-header {
    margin-left: 20px;
    text-align: left;
    font-weight: bold;
}

.pure-table {
    border-collapse: collapse;
    border-spacing: 0;
    empty-cells: show;
    border: 1px solid #cbcbcb
}

.pure-table caption {
    color: #000;
    font: italic 85%/1 arial, sans-serif;
    padding: 1em 0;
    text-align: center
}

.pure-table td,.pure-table th {
    border-left: 1px solid #cbcbcb;
    border-width: 0 0 0 1px;
    font-size: inherit;
    line-height: 20px;
    margin: 0;
    overflow: visible;
    padding: .25em .50em
}

.pure-table td:first-child,.pure-table th:first-child {
    border-left-width: 0
}

.pure-table thead {
    background: #e0e0e0;
    color: #000;
    text-align: left;
    vertical-align: bottom
}

.pure-table td {
    background-color: transparent
}

.pure-table-odd td {
    background-color: #e6f5fc
}

.pure-table-striped tr:nth-child(2n-1) td {
    background-color: #f2f2f2
}

.pure-table-bordered td {
    border-bottom: 1px solid #cbcbcb
}

.pure-table-bordered tbody>tr:last-child td,.pure-table-horizontal tbody>tr:last-child td
    {
    border-bottom-width: 0
}

.pure-table-horizontal td,.pure-table-horizontal th {
    border-width: 0 0 1px;
    border-bottom: 1px solid #cbcbcb
}

.pure-table-horizontal tbody>tr:last-child td {
    border-bottom-width: 0
}

span.dynatree-node a {
    font-size: 11px !important;
}

.wrapper1 .tooltip {
    color: black;
    display: block;
    left: 92px;
    margin-bottom: 15px;
    opacity: 0;
    padding: 20px;
    pointer-events: none;
    position: absolute;
    -webkit-transform: translateY(10px);
    -moz-transform: translateY(10px);
    -ms-transform: translateY(10px);
    -o-transform: translateY(10px);
    transform: translateY(10px);
    -webkit-transition: all .25s ease-out;
    -moz-transition: all .25s ease-out;
    -ms-transition: all .25s ease-out;
    -o-transition: all .25s ease-out;
    transition: all .25s ease-out;
    -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.28);
    -moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.28);
    -ms-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.28);
    -o-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.28);
    box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.28);
}

.link {
    text-decoration: underline;
    color: #0b71be !important;
    font-weight: normal !important;
    padding-right: 10px;
}

.notes {
    height: 25px;
    font-weight: bold;
    text-align: right;
    font-size: 12px;
    width: 105px !important;
    float: left;
    position: relative;
}

.notes-text-box {
    float: left;
    border: 1px solid #333;
    width: 160px !important;
    height: 22px;
    padding-left: 5px;
}

.notes-text-box1 {
    float: left;
    border: 1px solid #333;
    width: 167px !important;
    height: 25px;
    padding-left: 5px;
}

.notes-text-box3 {
    float: left;
    border: 1px solid #333;
    width: 75px !important;
    height: 25px;
    padding-left: 5px;
}

.notes1 {
    font-weight: bold;
    text-align: right;
    width: 200px;
    padding-left: 30px;
    font-size: 12px;
    float: left;
    position: relative;
}

.notes-textbox {
    float: left;
    border: 1px solid #333;
    width: 400px;
    height: 50px;
    padding-left: 5px;
    position: relative;
    margin-left: 20px;
    margin-bottom: 20px;
}

.popup_top_info {
    background-color: #e3e3e3;
    border-bottom: 1px solid #000;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    font-size: 18px;
    margin-right: 0;
    margin-top: 0;
    padding: 10px 567px 9px 5px !important;
}

.headerRow1 {
    color: #fff !important;
    background-color: #277AA8 !important;
    font-size: 11.5px !important;
    line-height: 20px;
}

.Popup4 {
    background-color: white;
    text-align: centre;
    z-index: 0;
    left: 50%;
    position: absolute;
    width: 600px;
    height: 360px;
    margin-left: -250px;
    valign: top;
    border-style: solid;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    border-width: 3px 1px 1px;
    -moz-box-shadow: 0px 0px 10px rgba(0, 0, 0, 1);
    -webkit-box-shadow: 0px 0px 10px rgba(0, 0, 0, 1);
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 1);
    font-size: 12px;
    top: 20%;
}

.Popup_Terr {
    background-color: white;
    border: #000 1px solid;
    text-align: center;
    z-index: 0;
    left: 50%;
    position: absolute;
    width: 600px;
    height: 250px;
    margin-left: -450px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    valign: top;
    -moz-box-shadow: 0px 0px 10px rgba(0, 0, 0, 1);
    -webkit-box-shadow: 0px 0px 10px rgba(0, 0, 0, 1);
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 1);
    font-size: 14px;
    top: 20%;
}

.popupBackground {
    background-color: black;
    opacity: 0.20;
    filter: alpha(opacity = 20);
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 0;
}

.popupBackgroundworkbench {
    background-color: black;
    opacity: 0.20;
    filter: alpha(opacity = 20);
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 0;
}

.customPopup {
    padding: 10px;
    left: 50%;
    margin-left: -350px;
    position: absolute;
    z-index: 2000;
    width: 700px;
    top: 20%;
}

.customPopupSc {
    background-color: white;
    border-style: solid;
    border: #003f77 1px solid;
    border-top: #003f77 2px solid;
    padding: 10px;
    left: 50%;
    margin-left: -350px;
    position: absolute;
    z-index: 2222;
    width: 700px;
    top: 20%;
}

.customPopup_OK {
    background-color: white;
    border-style: solid;
    border: #003f77 1px solid;
    border-top: #003f77 2px solid;
    padding: 20px;
    height: 200px;
    left: 50%;
    margin-left: -200px;
    position: absolute;
    z-index: 2000;
    width: 450px;
    height: 400px;
    top: 20%;
}

.pagination {
    width: 750px;
    text-align: center;
    height: 30px;
    padding: 7px 0px;
    margin-left: 25%;
}

.page-buttons {
    font-size: 12px !important;
    font-weight: bold !important;
    height: 22px !important;
    text-align: right;
}

}
br {
    line-height: 10px !important;
}
</style>
        </head>
        <!-- Add code to initialize the tree when the document is loaded: -->
        <apex:outputpanel id="scriptPanel">
            <script type="text/javascript">
                $j = jQuery.noConflict();
                function appendSorting(){
                    refreshTree();
                   console.log('called');
                   currency();
                   numbr();
                   $j('[id$="posPbTableNew"]').tablesorter();
                }

                function clearFilter(){
                    $j("[id$='sfld']").val('');
                }

                $j(function(){

                 //var ele= $('[id="mainpage:form1:thePBasd:maintable"]');
                 //$(".tablesorter").tablesorter();
                     // Attach the dynatree widget to an existing <div id="tree"> element
                     // and pass the tree options as an argument to the dynatree() function:
                     $j("#tree").dynatree({
                         onActivate: function(node) {
                             // A DynaTreeNode object is passed to the activation handler
                             // Note: we also get this event, if persistence is on, and the page is reloaded.


                             document.getElementById("mainpage:form1:input1").value=node.data.key;
                             document.getElementById("mainpage:form1:input2").value=node.data.title;

                             console.log("You activated " + document.getElementById("mainpage:form1:input1").value);
                             populateAccounts('true');
                         },



                            onPostInit:function(){
                        var tree = $j("#tree").dynatree("getTree");
                // Use it's class methods:

                         var i = 0;
                        $j("#tree").dynatree("getRoot").visit(function(node){

                        if(i>3)
                node.expand(false);
                i++;
                });

             tree.activateKey('{!activateDefault}');
             //alert('hello');
                 },

                         persist: false,
                         checkbox: false,
                         generateIds: false,
                         classNames: {
                             checkbox: "dynatree-checkbox",
                             expanded: "dynatree-expanded"
                         },
                         selectMode: 3,
                         children: {!JsonString},
                         onSelect: function(select, node) {
                             // Get a list of all selected nodes, and convert to a key array:
                             var selKeys = $j.map(node.tree.getSelectedNodes(), function(node){
                                 return node.data.id;
                             });
                             jQuery(document.getElementById("{!$Component.selectedKeys}")).val(selKeys.join(", "));

                             // Get a list of all selected TOP nodes
                             var selRootNodes = node.tree.getSelectedNodes(true);
                             // ... and convert to a key array:
                             var selRootKeys = $j.map(selRootNodes, function(node){
                                 return node.data.key;
                             });
                         },
                     });
                 });
                // Pass Position Id of the selected radio button
                 function passSelected(position){

                   //alert(position);
                   document.getElementById("mainpage:form1:input3").value =  position;
                   refresh();
                 }

                 //Disable enter
                 function stopRKey(evt) {
                   var evt = (evt) ? evt : ((event) ? event : null);
                   var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
                   if ((evt.keyCode == 13) && (node.type=="text"))  {return false;}
                 }
                document.onkeypress = stopRKey;
                function refreshTree(){
                    var tree = $j("#tree").dynatree("getRoot");
                    console.log('--- : activateDefault :----');
                }
        </script>
        </apex:outputpanel>
        <!--  ------------------- Loading Status ---------------------------- -->
        <apex:actionStatus id="myStatus">
            <apex:facet name="start">
                <div>
                    <div class="popupBackground"></div>
                    <div class="PopupPanel"
                        style="position: absolute; left: 50%; top: 7%;">
                        <table border="0" width="100%" height="100%" cellspacing="0">
                            <tr>
                                <td align="center"><b>Please Wait</b></td>
                            </tr>
                            <tr>
                                <td align="center"><img src="/img/loading.gif" /></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </apex:facet>
        </apex:actionStatus>
        <!-------------------------------------VF Page--------------------------------------->
        <apex:actionfunction name="refresh" action="{!refresh}"
            rerender="CTButton" />
        <apex:actionfunction name="populateAccounts" action="{!populateTerritory}" rerender="thePBasd,pnl3,input3,ButtonPanel,buttonPnl,msgPnl" oncomplete="appendSorting();" status="myStatus">
            <apex:param name="clickedFirst" assignTo="{!clickedFirst}" value="true"/>
        </apex:actionfunction>
        <!-- Add a <div> element where the tree should appear: -->

        <div class="box-main">
            <apex:outputText value="No more request allowed in this quarter"
                rendered="{!NOT(isSubmissionAllowed)}" style="color:blue; font-size:15px; font-weight:bold;"/>
            <div class="box-top">

                <apex:outputpanel id="pnl3">
                    <div class="box-top-div1">
                        {!loggedInUserName} <span style="font-size: 13px">({!loggedInUserProfile})</span>
                    </div>
                    <div class="box-top-div2">
                        <apex:inputtext value="{!searchterm}" id="sfld"></apex:inputtext>
                        <apex:commandbutton value="Search" rerender="AccountPanel,msgPnl, buttonPnl" action="{!populateTerritory}" status="myStatus" oncomplete="appendSorting();">
                            <apex:param name="searchId" value="1884736" assignTo="{!searchId}" />
                            <apex:param name="clickedFirst" assignTo="{!clickedFirst}" value="true"/>
                        </apex:commandButton>
                        <apex:commandbutton value="Clear" rerender="AccountPanel,msgPnl, buttonPnl" onclick="clearFilter();" action="{!populateTerritory}" status="myStatus" oncomplete="appendSorting();">
                            <apex:param name="clickedFirst" assignTo="{!clickedFirst}" value="true"/>
                        </apex:commandButton>
                    </div>
                </apex:outputpanel>
                                <div class="box-top-div3">
                        <apex:outputPanel id="buttonPnl">
                        <apex:commandButton value="Previous" action="{!goPreviousPage}" disabled="{!buttonDisalblePrev}" style="font-size:10px;" rerender="AccountPanel, buttonPnl" oncomplete="appendSorting();" status="myStatus"/>
                        &nbsp;&nbsp;&nbsp;&nbsp;showing : {!start + 1} - {!stop} of {!total}&nbsp;&nbsp;&nbsp;&nbsp;
                        <apex:commandButton value="Next" action="{!goNextPage}"  disabled="{!buttonDisalbleNext}" style="font-size:10px;" rerender="AccountPanel, buttonPnl" oncomplete="appendSorting();" status="myStatus"/>
                        </apex:outputPanel>
                  </div>
                <div class="box-top-div5">
                    <apex:outputPanel id="ButtonPanel">
                        <apex:commandbutton id="CTButton" value="Create Territory"
                            status="myStatus" action="{!createTerritory}"
                            reRender="popupCreate,AccountPanel,input3,ButtonPanel,myMsg"
                            rendered="{!AND(if(selectedTerPos!='' && selectedTerPos!=null,false,true), isSubmissionAllowed == true)}"
                            disabled="{!(hideButtonsforDSM || showForChangeName)}"
                            oncomplete="appendSorting();"></apex:commandbutton>&nbsp;&nbsp;
                    <apex:commandbutton value="Delete Territory"
                            status="myStatus" action="{!openDeletePopUp}"
                            rendered="{!isSubmissionAllowed}"
                            reRender="popupDelete,thePBasd,myMsg,ButtonPanel,input3,msgPnl"
                            disabled="{!(hideButtonsforDSM || showForChangeName)}"
                            oncomplete="appendSorting();"></apex:commandbutton>
                        <!--                    <apex:commandbutton value="Assign" action="{!assign}" reRender="AccountPanel,popupAssignUnA,input3,ButtonPanel"></apex:commandbutton>&nbsp;&nbsp; -->
                        <apex:commandbutton value="Change Name" status="myStatus"
                            action="{!changeTerritoryName}"
                            reRender="AccountPanel,popupAssignUnA,input3,ButtonPanel,myMsg,msgPnl"
                            disabled="{!(hideButtonsforDSM || showForChangeName)}"
                            oncomplete="appendSorting();"></apex:commandbutton>&nbsp;&nbsp;


                        <apex:actionStatus id="goChangeName">
                            <apex:facet name="stop">
                                <apex:outputPanel >
                                    <apex:commandbutton value="Save" action="{!saveTerName}"
                                        status="goChangeName"
                                        reRender="AccountPanel,popupAssignUnA,input3,ButtonPanel,myMsg,msgPnl, scriptPanel, buttonPnl, treePanel"
                                        rendered="{!showForChangeName }" oncomplete="appendSorting();"></apex:commandbutton>&nbsp;&nbsp;
                        <apex:commandbutton value="Cancel"
                                        action="{!cancel}"
                                        reRender="AccountPanel,popupAssignUnA,input3,ButtonPanel,myMsg,msgPnl"
                                        rendered="{!showForChangeName }" oncomplete="appendSorting();"></apex:commandbutton>&nbsp;&nbsp;

                                </apex:outputPanel>
                            </apex:facet>
                            <apex:facet name="start">
                                <apex:outputPanel >
                                    <apex:commandbutton value="Processing..." disabled="true"
                                        reRender="AccountPanel,popupAssignUnA,input3,ButtonPanel,myMsg"></apex:commandbutton>&nbsp;&nbsp;
                        <apex:commandbutton value="Processing..."
                                        disabled="true"
                                        reRender="AccountPanel,popupAssignUnA,input3,ButtonPanel,myMsg"></apex:commandbutton>&nbsp;&nbsp;

                                </apex:outputPanel>
                            </apex:facet>
                        </apex:actionStatus>


                    </apex:outputPanel>
                </div>
            </div>
            <div class="box-content">
             <apex:outputPanel id="treePanel">
                <div class="tree1">
                    <div class="table_header_tree">Territory Organization</div>
                    <div id="tree"></div>
                </div>
                 </apex:outputPanel>
                <div class="tablecontent">
                    <apex:outputPanel id="AccountPanel">
                        <apex:pageBlock id="thePBasd" mode="maindetail">
                        <table id="posPbTableNew" width="100%" cellspacing='0'>
                            <thead style="border:0px !important; border-collapse:collapse !important;">
                            <tr >
                                <th>Action</th>
                                <th>Territory Id</th>
                                <th>Territory Name</th>
                                <th>Employee</th>
                                <th># Accounts</th>
                                <th>Billable</th>
                                <th>Opportunity</th>
                                <th>Alignment Index</th>
                                <th>Drive Time</th>
                                <th>Approval Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            <apex:repeat value="{!Territories}" var="wrap">
                                <tr>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                        <apex:outputpanel rendered="{!!(wrap.reqStatus=='Pending' && wrap.i=3)}">
                                            <input type="radio" name="fam"
                                                onclick="passSelected('{!wrap.pos.Id}');" />
                                            <apex:actionSupport event="onclick" action="{!refresh}"
                                                rerender="ButtonPanel,CTButton,input3" status="myStatus" />
                                        </apex:outputpanel>
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                            {!wrap.pos.Territory__r.SalesIQ__Territory_Id__c}
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                         <apex:outputPanel rendered="{!!showTextBox}">
                                            {!If((wrap.ChangedTerritoryName!='' && wrap.ChangedTerritoryName!=wrap.pos.Territory__r.name),wrap.ChangedTerritoryName,wrap.pos.Territory__r.name)}
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!showTextBox}">
                                            <apex:inputtext value="{!wrap.ChangedTerName}"
                                                 disabled="{!if(wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change',true,false)}" />
                                        </apex:outputPanel>
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                        {!wrap.pos.user__r.name}
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                        {!wrap.noOfAcc}
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                        <span class="currency">{!wrap.billable}</span>
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                        <span class="currency">{!wrap.opportunityAmount}</span>
                                    </td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}"><span class="number">{!wrap.assignmentIndex}</span></td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">{!wrap.driveTime}</td>
                                    <td style="{!IF((wrap.reqStatus!='Completed' && wrap.reqStatus!='' && wrap.reqType!='Territory Name Change') || (wrap.reqStatus=='Pending' && wrap.reqType=='Territory Name Change'), 'background-color:#fbc9b1; padding-right:20px;text-align:left;','padding-right:20px;text-align:left;')}">
                                        <apex:commandLink rendered="{!if(wrap.reqId=='' || wrap.reqId==null,true,false)}"
                                        title="{!wrap.reqtype3} {!wrap.reqName3} {!wrap.reqtype2} {!wrap.reqName2} {!wrap.reqtype1} {!wrap.reqName1} {!wrap.reqtype4} {!wrap.reqName4}"
                                         target="_blank" action="{!passFilterTerm}">{!wrap.reqStatus}
                                        <apex:param name="filterTerm"
                                            value="{!wrap.pos.Territory__r.id}" assignTo="{!filterTerm}" />

                                        </apex:commandLink>
                                        <apex:commandLink rendered="{!if(wrap.reqId!='' && wrap.reqId!=null ,true,false)}"
                                            title="{!wrap.reqtype3} {!wrap.reqName3} {!wrap.reqtype2} {!wrap.reqName2} {!wrap.reqtype1} {!wrap.reqName1} {!wrap.reqtype4} {!wrap.reqName4}"
                                            target="_blank" action="{!passFilterTerm}">{!wrap.reqStatus}
                                            <apex:param name="accMovmntReqId" value="{!wrap.reqId}"
                                                assignTo="{!accMovmntReqId}" />

                                        </apex:commandLink>
                                    </td>
                                </tr>
                            </apex:repeat>
                            </tbody>
                        </table>
                        </apex:pageBlock>
                    </apex:outputPanel>
                </div>
            </div>
        </div>

        <apex:inputhidden id="input1" value="{!selectedPosition}" />
        <apex:inputhidden id="input2" value="{!selectedNode}" />
        <apex:inputhidden id="input3" value="{!selectedTerPos}" />

        <!-----------------------Pop Up Create Territory------------------->
        <apex:outputPanel id="popupCreate">
            <apex:outputPanel styleClass="popupBackground" layout="block"
                rendered="{!displayPopUpCreate}" />
            <apex:outputPanel styleClass="customPopup" layout="block"
                rendered="{!displayPopUpCreate}">
                <div class="box-main-popup">
                    <div class="box-top-popup">
                        <div class="box-top-div1">Create Territory</div>
                    </div>
                    <div class="box-content-popup">
                        <apex:pageMessages id="popupMsg" />
                        <apex:pageblock mode="maindetail">
                            <table width="600" border="0" cellspacing="10" cellpadding="0">
                                <tr>
                                    <td class="notes"><apex:outputlabel value="Region" /></td>
                                    <td><apex:inputText value="{!selRegion}"
                                            styleClass="notes-text-box" disabled="true"/></td>
                                    <td class="notes"><apex:outputlabel value="District" /></td>
                                    <td><apex:selectList styleClass="notes-text-box1"
                                            value="{!selDistrict1}" size="1" disabled="true">
                                            <apex:selectOptions value="{!districts}" />
                                        </apex:selectList></td>
                                </tr>

                                <tr>
                                    <td class="notes"><apex:outputlabel value="Territory ID" /></td>
                                    <td><apex:inputText value="{!newTerritoryId}"
                                            styleClass="notes-text-box" disabled="true" /></td>
                                    <td class="notes"><apex:outputlabel value="Territory Name" />
                                    </td>
                                    <td><apex:inputText value="{!newTerritoryName}"
                                            styleClass="notes-text-box" /></td>
                                </tr>
                                <tr>
                                    <td class="notes"><apex:outputlabel value="Reason" /></td>
                                    <td><apex:inputText value="{!reason}"
                                            styleClass="notes-text-box" /></td>
                                    <td class="notes"><apex:outputlabel value="Effective Start Date" /></td>
                                    <td><apex:selectList value="{!effectiveDate}"
                                            styleClass="notes-text-box1" size="1">
                                            <apex:selectOptions value="{!StartDates}" />
                                        </apex:selectList></td>

                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                            </table>
                        </apex:pageblock>
                        <div style="text-align: center">
                            <apex:commandButton value="Refresh"
                                style="background:#36647D;color: #FFF; width:70px; height:25px; font-size:12px;"
                                action="{!refreshTerritory}" rerender="popupCreate,popupCon,panelbutton"
                                rendered="{!if(isexception==true,true,false)}"
                                 />
                      <apex:outputPanel id="panelbutton" rendered="{!if(isexception==false,true,false)}">
                            <apex:commandButton value="Save"
                                style="background:#36647D;color: #FFF; width:70px; height:25px; font-size:12px;"
                                action="{!showMessage}" rerender="popupCreate,popupCon"
                                rendered="{!if(showAnothersave==0,true,false)}"
                                oncomplete="appendSorting();" />


                            <apex:commandButton value="Assign AC"
                                style="background:#36647D;color: #FFF; width:85px; height:25px; font-size:12px;"
                                action="{!assignAC}" rerender="popupCreate,thePBasd"
                                rendered="{!if(showAnothersave==0,true,false)}" />
                            <apex:commandButton value="
                                Assign
                                Accounts"
                                style="background:#36647D;color: #FFF; width:120px; height:25px; font-size:12px;"
                                action="{!assignAccountsNewTer}" rerender="popupCreate,thePBasd"
                                rendered="{!if(showAnothersave==0,true,false)}" />

                            <apex:commandButton value="Cancel"
                                style="background:#36647D;color: #FFF; width:70px; height:25px; font-size:12px;"
                                action="{!closePopup}" rerender="popupCreate,myMsg"
                                oncomplete="appendSorting();"
                                rendered="{!if(showAnothersave==0,true,false)}" />

                            <apex:actionStatus id="go" onstop="appendSorting();"
                                rendered="{!if(showAnothersave==1,true,false)}">
                                <apex:facet name="stop">
                                    <apex:outputPanel >
                                        <apex:commandButton value="Save"
                                            style="background:#36647D;color: #FFF; width:70px; height:25px; font-size:12px;"
                                            action="{!saveTerritory}" status="go" disabled="false"
                                            rerender="go,popupCreate,popupCon,thePBasd,popupMsg, scriptPanel, buttonPnl, treePanel" oncomplete="appendSorting();"/>

                                        <apex:commandButton value="Assign AC"
                                            style="background:#36647D;color: #FFF; width:85px; height:25px; font-size:12px;"
                                            action="{!assignAC}" rerender="popupCreate,thePBasd" />
                                        <apex:commandButton value="Assign Accounts"
                                            style="background:#36647D;color: #FFF; width:120px; height:25px; font-size:12px;"
                                            action="{!assignAccountsNewTer}"
                                            rerender="popupCreate,thePBasd" />

                                        <apex:commandButton value="Cancel"
                                            style="background:#36647D;color: #FFF; width:70px; height:25px; font-size:12px;"
                                            action="{!closePopup}" rerender="popupCreate,myMsg"
                                            oncomplete="appendSorting();" />

                                    </apex:outputPanel>

                                </apex:facet>
                                <apex:facet name="start">
                                    <apex:outputPanel >
                                        <apex:commandButton style="background:#36647D;color: #FFF; width:90px; height:25px; font-size:12px;"
                                            value="Processing..." disabled="true"
                                            rerender="go,popupCreate,thePBasd" />

                                        <apex:commandButton style="background:#36647D;color: #FFF; width:95px; height:25px; font-size:12px;"
                                            value="Processing..." disabled="true"
                                            rerender="popupCreate,thePBasd" />
                                        <apex:commandButton style="background:#36647D;color: #FFF; width:90px; height:25px; font-size:12px;"
                                            value="Processing..." disabled="true"
                                            rerender="popupCreate,thePBasd" />

                                        <apex:commandButton style="background:#36647D;color: #FFF; width:90px; height:25px; font-size:12px;"
                                            value="Processing..." disabled="true"
                                            rerender="popupCreate,myMsg" />

                                    </apex:outputPanel>


                                </apex:facet>
                            </apex:actionStatus>
                     </apex:outputPanel>

                        </div>
                        <br />
                    </div>
                </div>

            </apex:outputPanel>
        </apex:outputPanel>
        <!-----------------------Pop Up Delete Territory------------------>
        <apex:outputPanel id="popupDelete">
            <apex:outputPanel styleClass="popupBackground" layout="block"
                rendered="{!(displayDeleteAll )}" />
            <apex:outputPanel styleClass="customPopup" layout="block"
                rendered="{!(displayDeleteAll )}">
                <div class="box-main-popup" style="margin-top: -2px;">
                    <div class="box-top-popup">
                        <div class="box-top-div1">Delete Territory</div>
                    </div>
                    <div class="box-content-popup">

                        <br />
                        <apex:pageMessages id="delMsg" />
                        <!-- ------------Display this panel when there is either of User or Accounts are assigned to the territory------------- -->
                        <apex:outputPanel id="pan1"
                            rendered="{!(hasAccounts || hasUser) && !(unAssignAcc || unAssignedAC)}">
                            <div style="text-align: center">

                                <apex:outputText id="p1" rendered="{!!confirmUnassign}">Kindly perform below action before deleting <b>"{!selTerritory}"</b>
                                </apex:outputText>
                                <br />
                                <!--                                                                 <apex:outputText id="p2" rendered="{!confirmUnassign}">Are you sure you want to Un-Assign "{!userToUnassign}" from territory "{!selTerritory}"?</apex:outputText><br/> -->


                                <apex:outputPanel id="allexist"
                                    rendered="{!(hasAccounts && hasUser)}">
                                    <apex:image id="img1" value="{!$Resource.SalesIQ__redIcon}" width="13"
                                        height="13" /> Un-Assign AC<br />
                                    <apex:image id="img2" value="{!$Resource.SalesIQ__redIcon}" width="13"
                                        height="13" /> Un-Assign Accounts
                                                                </apex:outputPanel>
                                <apex:outputPanel id="noUser" rendered="{!!hasUser}">

                                    <apex:image id="img3" value="{!$Resource.SalesIQ__redIcon}" width="13"
                                        height="13" /> Un-Assign Accounts <br />
                                    <!--                                                                         * There is no User assigned to this territory.  -->
                                </apex:outputPanel>
                                <apex:outputPanel id="noAccounts" rendered="{!!hasAccounts}">

                                    <apex:image id="img5" value="{!$Resource.SalesIQ__redIcon}" width="13"
                                        height="13" /> Un-Assign AC <br />
                                    <!--                                                                         * There are no Accounts assigned to this territory. -->
                                </apex:outputPanel>
                                <br />
                            </div>
                            <br />
                            <br />
                            <div style="text-align: center">
                                <!--                                                         <apex:commandButton value="Un-Assign AC" style="background:#36647D;color: #FFF; width:100px; height:25px; font-size:12px;" action="{!unAssignAC}" rerender="popupDelete,thePBasd" rendered="{!!confirmUnassign && hasUser}"/> -->
                                <!--                                                         <apex:commandButton value="Confirm" style="background:#36647D;color: #FFF; width:100px; height:25px; font-size:12px;" action="{!ConfUnAssignAC}" rerender="popupDelete,thePBasd, pan5,pan6" rendered="{!confirmUnassign}"/> -->
                                <!--                                                         <apex:commandButton value="Un-Assign Accounts" style="background:#36647D;color: #FFF; width:125px; height:25px; font-size:12px;" action="{!unAssignAccounts}" rerender="popupDelete,thePBasd" rendered="{! hasAccounts}"/> -->
                                <apex:commandButton value="Close"
                                    style="background:#36647D;color: #FFF; width:90px; height:25px; font-size:12px;"
                                    action="{!closePopup}" rerender="popupDelete,thePBasd,myMsg" />
                            </div>
                            <br />

                        </apex:outputPanel>



                        <!-- --------------------Display this panel when there is no User/Accounts assigned to the territory--------------------- -->
                        <apex:outputPanel id="pan4"
                            rendered="{!!(hasAccounts || hasUser)}">
                            <div style="text-align: center;">
                                There are no User/Accounts assigned to the territory <b>"{!selTerritory}"</b>.
                                <br />Are you sure you want to delete the territory?
                            </div>
                            <br />
                            <div style="text-align: center">
                                <apex:actionStatus id="goDeleteTerritory" onstop="appendSorting();">
                                    <apex:facet name="stop">
                                        <apex:outputPanel >
                                            <apex:commandButton value="Delete"
                                                style="background:#36647D;color: #FFF; width:80px; height:25px; font-size:12px;"
                                                action="{!deleteTerritory}"
                                                rerender="popupDelete,scriptPanel,thePBasd,myMsg,msgPnl,treePanel,delMsg"
                                                status="goDeleteTerritory" oncomplete="refreshTree();"/>
                                &nbsp;&nbsp;
                                <apex:commandButton value="Cancel"
                                                style="background:#36647D;color: #FFF; width:80px; height:25px; font-size:12px;"
                                                action="{!closePopup}" rerender="popupDelete,thePBasd,myMsg" />
                                        </apex:outputPanel>
                                    </apex:facet>
                                    <apex:facet name="start">
                                        <apex:outputPanel >
                                            <apex:commandButton value="Processing..." disabled="true"
                                                style="background:#36647D;color: #FFF; width:80px; height:25px; font-size:12px;"
                                                rerender="popupDelete,thePBasd,myMsg,msgPnl" />
                                &nbsp;&nbsp;
                                <apex:commandButton value="Processing..." disabled="true"
                                                style="background:#36647D;color: #FFF; width:80px; height:25px; font-size:12px;"
                                                rerender="popupDelete,thePBasd,myMsg" />
                                        </apex:outputPanel>
                                    </apex:facet>
                                </apex:actionStatus>

                            </div>
                            <br />
                        </apex:outputPanel>

                        <br />
                        <!-- --------------------Display this panel after unassigning AC from a territory where no accounts were assigned-------------------- -->
                        <apex:outputPanel id="pan5" rendered="{!unAssignedAC}">
                            <div style="text-align: center">
                                <apex:outputText id="pa" rendered="{!confirmUnassign}">"{!userToUnassign}" is Un-Assigned from "{!selTerritory}".</apex:outputText>


                                <br />
                            </div>
                            <br />
                            <br />
                            <div style="text-align: center">

                                <apex:commandButton value="Cancel"
                                    style="background:#36647D;color: #FFF; width:90px; height:20px; font-size:12px;"
                                    action="{!closePopup}" rerender="popupDelete,thePBasd,myMsg" />
                            </div>
                            <br />

                        </apex:outputPanel>
                    </div>
                </div>

            </apex:outputPanel>
        </apex:outputPanel>
    </apex:form>
    <script>
    var format = function(numStr, prefix){
        var str = numStr, parts = false, output = [], i = 1, formatted = null;
        if(str.indexOf(".") > 0) {
            parts = str.split(".");
            str = parts[0];
        }
        str = str.split("").reverse();
        for(var j = 0, len = str.length; j < len; j++) {
            if(str[j] != ",") {
                output.push(str[j]);
                if(i%3 == 0 && j < (len - 1)) {
                    output.push(",");
                }
                i++;
            }
        }
        formatted = output.reverse().join("");
        return(prefix + formatted);
    };

    var $j = jQuery.noConflict();
    var currency = function(){
        $j('.currency').each(function(){
            $j(this).text(format($j(this).text(), "$"));
        });
    };

    var numbr = function(){
        $j('.number').each(function(){
            $j(this).text(format($j(this).text(), ""));
        });
    };
    </script>
        <div style="width:100%;">
        <apex:image id="logoImg" url="{!$Resource.SalesIQ__SalesIQ_Logo}" style="float:right;"/>
    </div>
</apex:page>